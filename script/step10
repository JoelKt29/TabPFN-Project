import torch
import numpy as np
import matplotlib.pyplot as plt
from tabpfn import TabPFNRegressor # Le mod√®le "de base" pour comparer
from step8_transfer_learning import TabPFNSABRRegressor # Ton mod√®le hybride
from step9_finetuning_causal_graph import SABRCausalGenerator # Ton g√©n√©rateur causal

def run_performance_duel():
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    generator = SABRCausalGenerator()
    
    # 1. Pr√©paration des Mod√®les
    # Ton mod√®le modifi√© (Causal)
    my_model = TabPFNSABRRegressor().to(device)
    my_model.load_state_dict(torch.load("tabpfn_sabr_causal_final.pth", map_location=device))
    my_model.eval()
    
    # Le mod√®le standard (Base)
    base_model = TabPFNRegressor(device='cpu')
    
    # 2. G√©n√©ration des donn√©es de Test (Un Smile de Volatilit√©)
    # On fixe les param√®tres pour avoir une courbe coh√©rente
    X_test, y_true = generator.generate(batch_size=300)
    # On trie par Strike (log-moneyness) pour l'affichage
    idx = X_test[:, -1].argsort()
    X_test_sorted = X_test[idx]
    y_true_sorted = y_true[idx]

    # 3. Inf√©rence
    print("üöÄ Duel en cours...")
    with torch.no_grad():
        # Pr√©diction de ton mod√®le
        y_pred_mine = my_model(X_test_sorted.to(device)).cpu().numpy()[:, 0]
        
        # Pr√©diction du TabPFN standard (In-Context Learning)
        # On lui donne 100 points de contexte pour qu'il puisse "deviner"
        X_train_ctx, y_train_ctx = generator.generate(batch_size=100)
        base_model.fit(X_train_ctx.numpy(), y_train_ctx.numpy()[:, 0])
        y_pred_base = base_model.predict(X_test_sorted.numpy())

    # 4. Graphique de Comparaison
    plt.figure(figsize=(12, 7))
    
    # La v√©rit√© terrain (SABR Math√©matique)
    plt.plot(X_test_sorted[:, -1], y_true_sorted[:, 0], 'k-', label='Vrai SABR (Hagan Formula)', linewidth=3, alpha=0.4)
    
    # TabPFN de base (Step 4 style)
    plt.plot(X_test_sorted[:, -1], y_pred_base, 'b--', label='TabPFN Standard (Step 4)', alpha=0.8)
    
    # Ton mod√®le (Step 9 Causal)
    plt.plot(X_test_sorted[:, -1], y_pred_mine, 'r-', label='Ton TabPFN-SABR (Causal + Sobolev)', linewidth=2)

    plt.title("Duel de Performance : Mod√®le Standard vs Mod√®le Modifi√© Causal")
    plt.xlabel("Log-Moneyness (K/F)")
    plt.ylabel("Volatilit√© Impliqu√©e")
    plt.legend()
    plt.grid(True, linestyle=':', alpha=0.6)
    
    # Petit encadr√© avec les erreurs (MAE)
    mae_base = np.mean(np.abs(y_pred_base - y_true_sorted[:, 0].numpy()))
    mae_mine = np.mean(np.abs(y_pred_mine - y_true_sorted[:, 0].numpy()))
    
    textstr = f'MAE Standard: {mae_base:.5f}\nMAE Ton Mod√®le: {mae_mine:.5f}'
    plt.gcf().text(0.15, 0.2, textstr, fontsize=10, bbox=dict(facecolor='white', alpha=0.5))

    plt.savefig("duel_performance_step9.png")
    plt.show()

if __name__ == "__main__":
    run_performance_duel()