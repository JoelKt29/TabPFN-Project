import torch
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
from pathlib import Path

# --- 1. SETUP ---
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
current_dir = Path(__file__).resolve().parent
model_path = current_dir / "tabpfn_sabr_step9_causal_final.pth"

# On charge une ligne de données réelle comme base
df = pd.read_csv(current_dir.parent / "data" / "sabr_with_derivatives_scaled.csv")
sample = df.iloc[0].copy()

# On définit une plage d'Alpha "Stress Test" (du très bas au très haut)
alphas = np.linspace(df['alpha'].min(), df['alpha'].max() * 1.5, 100)

# --- 2. PRÉPARATIONS DES TESTS ---
test_inputs = []
for a in alphas:
    row = sample[['beta', 'rho', 'volvol', 'v_atm_n', 'alpha', 'F', 'K', 'log_moneyness']].values.copy()
    row[4] = a  # On modifie l'Alpha
    test_inputs.append(row)
test_inputs = torch.FloatTensor(np.array(test_inputs)).to(device)

# Simulation de l'avis TabPFN (on garde une valeur moyenne pour le test)
fake_tab_preds = torch.full((100, 1), sample['volatility_scaled']).to(device)

# --- 3. INFÉRENCE ---
# (Assure-toi que la classe FinancialSCM est définie ou importée)
from step9_finetuning_causal_graph import FinancialSCM 
config = {"hidden_dims": [512, 256, 128]} # Config standard
model = FinancialSCM(config).to(device)
model.load_state_dict(torch.load(model_path))
model.eval()

with torch.no_grad():
    outputs = model(test_inputs, fake_tab_preds)
    predicted_vols = outputs[:, 0].cpu().numpy()
    predicted_alpha_greeks = outputs[:, 4].cpu().numpy() # La dérivée dV/dalpha apprise

# --- 4. GRAPHIQUE DE QUALITÉ ---
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))

# Haut : La Volatilité vs Alpha (Doit être une ligne droite ou courbe croissante propre)
ax1.plot(alphas, predicted_vols, color='blue', linewidth=2)
ax1.set_title("Test de Sensibilité Causale : Volatilité = f(Alpha)")
ax1.set_ylabel("Volatilité Prédite")
ax1.grid(True, alpha=0.3)

# Bas : Le Grec Alpha (Doit être toujours POSITIF et STABLE)
ax2.plot(alphas, predicted_alpha_greeks, color='green', linewidth=2)
ax2.axhline(y=0, color='red', linestyle='--') # La limite fatidique
ax2.set_title("Stabilité du Grec Alpha (dV/dAlpha)")
ax2.set_xlabel("Valeur de Alpha (Input)")
ax2.set_ylabel("Impact Causal")
ax2.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()